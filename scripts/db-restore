#!/bin/bash

source "$(dirname $_)/shared.sh"


[[ -f "$1" ]] || die "$1: No such file"

if [[ "$(head -c 6 "$1")" != "SQLite" ]]; then
	die "$1: Not an SQLite database"
fi

DATABASES=/data/data/$PKG/databases
TARGET=$DATABASES/db.sqlite

INFO=`adb-shell ls -l /data/data | grep $PKG`
FUID=`awk '{ print $2 }' <<<$INFO`
FGID=`awk '{ print $3 }' <<<$INFO`

if [[ -z $(run adb-shell mount | grep /data | grep rw) ]]; then
	echo -n "Remounting data/ read-write ... "
	run adb-shell mount -o remount,rw /data
	echo "done"
fi

run adb-shell mkdir -p $(dirname $TARGET)

echo -n "Pushing database to device ... "
adb push "$1" "$TARGET" || die

#echo -n "Moving to target directory ... "
#run adb-shell "cat '$DTEMP/.rxdroid.db' >  '$TARGET'"
#run adb-shell rm "$DTEMP/.rxdroid.db"
#echo "done"

echo -n "Fixing permissions ... "
run adb-shell chown $FUID.$FGID $DATABASES $DATABASES/"*"
run adb-shell chmod 600 $DATABASES/"*"
adb-shell am force-stop $PKG &> /dev/null

echo "done"
